<p>
<div class="row">
	<div class="col-lg-8"><button id='appendbtn' class='btn btn-primary'>
		<i class="icon-plus"></i> 新建客户
	</button>
	<button id='updatedbtn' class='btn btn-primary'>
		<i class="icon-save"></i> 保存
	</button></div>
	<div class="col-lg-4">
		<div class="input-group pull-right"><input type="text" class="form-control" id='searchtxt' placeholder="请请输入商品名"> <span
		class="input-group-btn">
		<button class="btn btn-primary" type="button" id='searchbtn'>查询</button>
	</span>
	</div>
	</div>
</div>
</p>
<div id='kkk'></div>

<script type="text/javascript">
	//var state = dic('userstate');
	var category;
	var unit;
	$.ajax({
		url : "goods/category",
		async : false,
		type : 'post',
		dataType : 'json',
		success : function(data) {
			if (data) {
				category = data;
			}
		}
	});
	$.ajax({
		url : "goods/unitlist",
		async : false,
		type : 'post',
		dataType : 'json',
		success : function(data) {
			if (data) {
				unit = data;
			}
		}
	});
	$('#kkk').table({
		columns : [
		//{header:"ID",field:"id",width:50,align:'center'},
		{
			header : "商品名",
			field : "name",
			align : 'left',
			tip : true,
			editor : {
				type : 'text'
			}
		}, {
			header : "类别",
			field : "category",
			align : 'left',
			width : 100,
			render : categoryRender,
			editor : {
				type : 'selectbox',
				option : {
					ds : category,
					textField : 'name',
					valueField : 'id'
				}
			}
		}, {
			header : "计量单位",
			field : "unit",
			align : 'left',
			width : 100,
			render : unitRender,
			editor : {
				type : 'selectbox',
				option : {
					ds : unit,
					textField : 'name',
					valueField : 'id'
				}
			}
		}, {
			header : "规格",
			field : "spec",
			align : 'left',
			width : 200,
			editor : {
				type : 'text'
			}
		}, {
			header : "操作",
			field : "",
			align : 'center',
			width : 100,
			render : opRender
		} ],
		url : 'goods/pager',
		condition : condition
	});
	$('#addbtn').click(add);
	$('#delbtn').click(del);
	$('#assignbtn').click(mk);
	$('#updatedbtn').click(function(){
		$('#kkk').table('endEdit');
		var mm = $('#kkk').table('getChanged');
		var text = JSON.stringify(mm);
		$.ajax({
			url : 'goods/changed',
			type : 'post',
			data : {changed: text},
			contentType: "application/x-www-form-urlencoded; charset=utf-8",
			dataType : 'json',
			success : function(result) {
				if (result.result) {
					$.pop(result.msg, function() {
						$('#kkk').table('refresh');
					});
				}
			}
		});
	});
	$('#appendbtn').click(function(){
		$('#kkk').table('addRow', 0, {name:'商品'});
	});
	function add() {
		$.dialog({
			title : '商品新增',
			url : 'view/goods/addgoods.html',
			drag : true,
			buttons : [ {
				text : '确定',
				cls : 'btn-primary',
				action : function(d) {
					ok(d);
				}
			}, {
				text : '关闭',
				cls : 'btn-default',
				action : function(d) {
					d.close();
				}

			} ],
			onShow : function() {
				$('#state').MultiRadio();
			}
		});
		//$('#kkk').Grid('addRow', {username:'asd'});
	}

	function ok(win) {
		var name = win.find('input[name=name]').val();
		var category = win.find('input[name=category]').val();
		var unit = win.find('input[name=unit]').val();
		var spec = win.find('input[name=spec]').val();
		var purchase_price = win.find('input[name=purchase_price]').val();
		var sale_price = win.find('input[name=sale_price]').val();
		var params = {
			name : name,
			category : category,
			unit : unit,
			spec : spec,
			purchase_price : purchase_price,
			sale_price : sale_price
		};
		$.ajax({
			url : 'goods/add',
			type : 'post',
			data : params,
			dataType : 'json',
			success : function(result) {
				if (result.result) {
					win.close();
					$.pop(result.msg, function() {
						$('#kkk').table('reload');
					});
					/**$.alert('success', result.msg, function(){
						$('#kkk').table('reload');
					});**/
				}
			}
		});
	}

	function save() {
		$('#kkk').Grid('save');
	}

	function del() {
		var selected = $('#kkk').table('getSelected');
		if (selected.length == 0) {
			$.tip({
				content : 'Please select one record!'
			});
			return false;
		}
		$.confirm('确定要干掉吗', function(btn) {
			if (btn) {
				var ids = [];
				for ( var k in selected) {
					ids.push(selected[k].id);
				}
				$.ajax({
					url : 'user/del',
					type : 'post',
					data : {
						ids : ids.join(',')
					},
					dataType : 'json',
					success : function(result) {
						$.pop(result.msg, function() {
							//$('#kkk').table('reload');
						});
						//$('#kkk').table('refresh');
					}
				});
			}
		});
	}

	function cancel() {
		var selected = $('#kkk').Grid('getSelected');
		if (selected.length == 0) {
			$.alert({
				msg : '请选择至少一条记录'
			});
			return false;
		}
		$.confirm({
			msg : '确定要禁止吗',
			callback : function(btn) {
				if (btn) {
					var ids = [];
					for ( var k in selected) {
						ids.push(selected[k].id);
					}
					$.ajax({
						url : 'user/cancel',
						type : 'post',
						data : {
							ids : ids.join(',')
						},
						dataType : 'json',
						success : function(result) {
							$('#kkk').Grid('refresh');
						}
					});
				}
			}
		});
	}

	function active() {
		var selected = $('#kkk').Grid('getSelected');
		if (selected.length == 0) {
			$.alert({
				msg : '请选择至少一条记录'
			});
			return false;
		}
		$.confirm({
			msg : '确定要激活吗',
			callback : function(btn) {
				if (btn) {
					var ids = [];
					for ( var k in selected) {
						ids.push(selected[k].id);
					}
					$.ajax({
						url : 'user/active',
						type : 'post',
						data : {
							ids : ids.join(',')
						},
						dataType : 'json',
						success : function(result) {
							$('#kkk').Grid('refresh');
						}
					});
				}
			}
		});
	}

	$('#searchbtn').click(function() {
		$('#kkk').table('reload');
	});

	function condition() {
		var name = $('#searchtxt').val();
		var params = {
			name : name
		};
		return params;
	}

	function stateRender(s) {
		//s = s||'1';
		//return "<font title='" + state[s] + "' color='" + {0:'red', 1:'green'}[s] + "'>"  +  state[s]  + "</font>";
		if (s == 1) {
			return "<label class='label label-success'>正常</label>";
		} else if (s == 0) {
			return "<label class='label label-danger'>锁定</label>";
		} else {
			return "<label class='label label-warning'>离职</label>";
		}
	}
	
	function genderRender(s) {
		if (s == 1) {
			return "<label class='label label-success'>男</label>";
		} else if (s == 2) {
			return "<label class='label label-danger'>女</label>";
		}
	}
	
	function categoryRender(v, r) {
		var c;
		$.each(category, function(){
			if(this['id'] == v){
				c = this['name'];
				return false;
			}
		});
		return c;
	}
	
	function unitRender(v, r) {
		var c;
		$.each(unit, function(){
			if(this['id'] == v){
				c = this['name'];
				return false;
			}
		});
		return c;
	}

	function opRender(v, r) {
		var h = [];
		h.push("<a class='btn btn-danger btn-sm' onclick=del2('" + r.id
				+ "') title='删除'><i class='icon-trash'></i></a>");
		return h.join('');
	}

	function del2(id) {
		$.confirm('确定要干掉吗', function(btn) {
			if (btn == 'YES') {
				var ids = [];
				ids.push(id);
				$.ajax({
					url : 'goods/del',
					type : 'post',
					data : {
						ids : ids.join(',')
					},
					dataType : 'json',
					success : function(result) {
						$.pop(result.msg, function() {
							$('#kkk').table('refresh');
						});
					}
				});
			}
		});
	}

	function assignrole(username) {
		$.dialog({
			title : '分配角色',
			url : 'user/tosetrole',
			params : {
				user : username
			},
			buttons : [ {
				text : 'OK',
				cls : 'btn-success',
				action : function(d) {
					ok1(d);
				}
			}, {
				text : 'Close',
				cls : 'btn-default',
				action : function(d) {
					d.close();
				}

			} ]
		});
	}

	function mk() {
		var selected = $('#kkk').table('getSelected');
		if (selected.length != 1) {
			$.tip({
				content : '请选择一条记录'
			});
			return false;
		}
		$.dialog({
			title : '分配角色',
			url : 'user/tosetrole?user=' + selected[0].username,
			buttons : [ {
				text : 'OK',
				cls : 'btn-success',
				action : function(d) {
					ok1(d);
				}
			}, {
				text : 'Close',
				cls : 'btn-default',
				action : function(d) {
					d.close();
				}

			} ]
		});
	}

	function ok1(win) {
		var user = win.find('input[name=user]').val();
		var roles = new Array();
		win.find('input[type=checkbox]:checked').each(function() {
			roles.push($(this).val());
		});
		var data = {
			user : user,
			roles : roles.join()
		};
		$.ajax({
			url : "user/setrole",
			type : 'post',
			data : data,
			dataType : 'json',
			success : function(result) {
				if (result.result) {
					win.close();
					$.alert('success', result.msg, function() {
						$('#kkk').table('reload');
					});
				}
			}
		});
	}
</script>