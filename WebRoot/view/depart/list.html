<table>
	<tr>
		<td<ul id="departtree" class="ztree"
				style="width:260px; overflow:auto;float:left;"></ul></td>
		<td><from id='departdetail' class='form' style="float:left;">
			<table>
				<tr>
					<td class='form-label'>部门名称</td>
					<td><input type="text" id='name' name="name" class='txt'
						autocomplete="off" /></td>
				</tr>
				<tr>
					<td class='form-label'>上级部门</td>
					<td><input type="text" id='pNode' name="pNode" class='txt' /></td>
				</tr>
				<tr>
					<td class='form-label'>备注</td>
					<td><textarea id='memo' name="memo" class='textarea'></textarea></td>
				</tr>
			</table>
			</from></td>
	</tr>
</table>
<div>
	<a id='addbtn' class='btn btn-default'><i class="icon-plus"></i> 增加子部门</a>
</div>
<script type="text/javascript">
	var setting = {
		view : {
			dblClickExpand : false,
			showLine : true
		},
		data : {
			simpleData : {
				enable : true,
				pIdKey : "pid",
				rootPId : 0
			}
		},
        async: {  
            enable: true,  
            url:"depart/tree",
            autoParam:["id"]  
        },  
		callback : {
			onClick : onClick
		}
	};
	var treeNodes;
	$.ajax({
		async : false,
		cache : false,
		type : 'POST',
		dataType : "json",
		url : "depart/tree",
		data : {id : 0},
		success : function(data) {
			treeNodes = data;
		}
	});
	for(var k in treeNodes){
		treeNodes[k].isParent = true;
	}
	$.fn.zTree.init($("#departtree"), setting, treeNodes);  
	function onClick(event, treeId, treeNode, clickFlag) {
		if (treeNode.level >= 1) {
			var name = treeNode.name;
			var pNode = treeNode.getParentNode();
			var memo = treeNode.memo;
			var detail = $('#departdetail');
			$('#name', detail).val(name);
			$('#pNode', detail).val(pNode.name);
			$('#memo', detail).val(memo);
		}
	}

	function filter(node) {
		return (node.name.indexOf("k") > -1);
	}

	$('#addbtn').click(add);
	function add() {
		$.dialog({
			title : '部门新增',
			url : 'view/depart/add.html',
			buttons : [ {
				text : 'OK',
				cls : 'btn-success',
				action : function(d) {
					ok(d);
				}
			}, {
				text : 'Close',
				cls : 'btn-default',
				action : function(d) {
					d.close();
				}

			} ],
			onShow : function(){
				var treeObj = $.fn.zTree.getZTreeObj("departtree");  
           		var nodes = treeObj.getSelectedNodes();  
	            if (nodes.length>0)   
	            {  
	                $('input[name=pname]').val(nodes[0].name);
	                $('input[name=pid]').val(nodes[0].id);
	            }  
			}
		});
		//$('#kkk').Grid('addRow', {username:'asd'});
	}

	function ok(win) {
		var name = win.find('input[name=name]').val();
		var pid = win.find('input[name=pid]').val();
		var isParent = win.find('input[name=isParent]:checked').val();
		var memo = win.find('textarea[name=memo]').val();
		var params = {
			name : name,
			pid : pid,
			isParent : isParent,
			memo : memo
		};
		$.ajax({
			url : 'depart/add',
			type : 'post',
			data : params,
			dataType : 'json',
			contentType: "application/x-www-form-urlencoded; charset=utf-8", 
			success : function(result) {
				if (result.result) {
					win.close();
					var treeObj = $.fn.zTree.getZTreeObj("departtree");  
	           		var nodes = treeObj.getSelectedNodes();  
		            if (nodes.length>0)   
		            {  
	           			treeObj.updateNode(nodes[0]);
	                    treeObj.reAsyncChildNodes(nodes[0], "refresh"); 
					}
				}
			}
		});
	}

	function del() {
		var selected = $('#kkk').table('getSelected');
		if (selected.length == 0) {
			$.tip({
				content : 'Please select one record!'
			});
			return false;
		}
		$.confirm('确定要干掉吗', function(btn) {
			if (btn == 'YES') {
				var ids = [];
				for ( var k in selected) {
					ids.push(selected[k].id);
				}
				$.ajax({
					url : 'depart/del',
					type : 'post',
					data : {
						ids : ids.join(',')
					},
					dataType : 'json',
					success : function(result) {
						$('#kkk').table('refresh');
					}
				});
			}
		});
	}

	$('#search-form button').click(function() {
		$('#kkk').table('reload');
	});

	function del2(id) {
		$.confirm('确定要干掉吗', function(btn) {
			if (btn == 'YES') {
				var ids = [];
				ids.push(id);
				$.ajax({
					url : 'depart/del',
					type : 'post',
					data : {
						ids : ids.join(',')
					},
					dataType : 'json',
					success : function(result) {
						$('#kkk').table('refresh');
					}
				});
			}
		});
	}

	function mk() {
		var selected = $('#kkk').table('getSelected');
		if (selected.length != 1) {
			$.tip({
				content : '请选择一条记录'
			});
			return false;
		}
		$.dialog({
			title : '分配角色',
			url : 'user/tosetrole?user=' + selected[0].username,
			ok : ok1
		});
	}

	function ok1(win) {
		var user = win.find('input[name=user]').val();
		var roles = new Array();
		win.find('input[type=checkbox]:checked').each(function() {
			roles.push($(this).val());
		});
		var data = {
			user : user,
			roles : roles.join()
		};
		$.ajax({
			url : "user/setrole",
			type : 'post',
			data : data,
			dataType : 'json',
			success : function(result) {
				if (result.result) {
					win.close();
					$.alert('success', result.msg, function() {
						$('#kkk').table('reload');
					});
				}
			}
		});
	}

	function addemployee(name) {
		$.dialog({
			title : '添加员工',
			width : 600,
			padding : '1px',
			url : 'view/depart/addemp.html',
			params : {
				departname : name
			},
			buttons : [ {
				text : 'OK',
				cls : 'btn-success',
				action : function(d) {
					ok1(d);
				}
			}, {
				text : 'Close',
				cls : 'btn-default',
				action : function(d) {
					d.close();
				}

			} ]
		});
	}
</script>
