<from>
<table style='width:100%'>
	<tr>
		<td>采购单编号</td>
		<td><input type="text" id='no' name="no" class='txt'
			autocomplete="off" disabled="disabled"/></td>
		<td>拟定时间</td>
		<td><input type="text" id='createtime' name='createtime' class='txt' disabled="disabled"/></td>
		<td>拟定人</td>
		<td><input type="text" id='creator' name="creator" value=${user} class='txt' disabled="disabled"/></td>
	</tr>
	<tr>
		<td>供应商</td>
		<td><input type="text" id='supplier' name='supplier' class='txt' /></td>
		<td>入库仓库</td>
		<td><input type="text" id='warehouse' name="warehouse" class='txt' /></td>
		<td>备注</td>
		<td><input type="text" id='memo' name="memo" class='txt' /></td>
	</tr>
</table>
</from>
<p>
<a id='adddetail' class='btn btn-primary'><i class="icon-plus"></i> 新建明细</a>
<a id='savedetail' class='btn btn-primary'><i class="icon-plus"></i> 全部保存</a>
</p>
<div id='detail'></div>
<script type="text/javascript">
	$('#supplier').selectbox({
		url : 'supplier/list',
		textField : 'name',
		valueField : 'id'
	});
	$('#warehouse').selectbox({
		url : 'warehouse/list',
		textField : 'name',
		valueField : 'id'
	});
	var date = new Date();
	var yyyy = date.getFullYear();
	var MM = date.getMonth() + 1;
	var dd = date.getDate();
	$('#no').val('P' + yyyy + MM + dd);
	$('#createtime').val(yyyy + '-' + MM + '-' + dd);
	var unit;
	$.ajax({
		url : "goods/unitlist",
		async : false,
		type : 'post',
		dataType : 'json',
		success : function(data) {
			if (data) {
				unit = data;
			}
		}
	});
	var goods;
	$.ajax({
		url : "goods/list",
		async : false,
		type : 'post',
		dataType : 'json',
		success : function(data) {
			if (data) {
				goods = data;
			}
		}
	});
	$('#detail').table({
		columns : [
		//{header:"ID",field:"id",width:50,align:'center'},
		{
			header : "商品名",
			field : "goods",
			align : 'left',
			tip : true,
			render : goodsRender,
			editor : {
				type : 'text'
			}
		}, {
			header : "规格",
			field : "spec",
			align : 'left',
			width : 180,
			editor : {
				type : 'text'
			}
		}, {
			header : "计量单位",
			field : "unit",
			align : 'left',
			width : 100,
			render : unitRender,
			editor : {
				type : 'selectbox',
				option : {
					ds : unit,
					textField : 'name',
					valueField : 'id'
				}
			}
		}, {
			header : "采购价格",
			field : "purchase_price",
			align : 'left',
			width : 100,
			editor : {
				type : 'text'
			}
		}, {
			header : "采购数量",
			field : "purchase_num",
			align : 'center',
			width : 100,
			editor : {
				type : 'text'
			}
		}, {
			header : "采购金额",
			field : "purchase_money",
			align : 'center',
			width : 100,
			editor : {
				type : 'text'
			}
		}, {
			header : "操作",
			field : "",
			align : 'center',
			width : 80,
			render : opRender
		} ],
		data : []
	});
	function unitRender(v, r) {
		var c;
		$.each(unit, function(){
			if(this['id'] == v){
				c = this['name'];
				return false;
			}
		});
		return c;
	}
	function goodsRender(v, r) {
		var c;
		$.each(goods, function(){
			if(this['id'] == v){
				c = this['name'];
				return false;
			}
		});
		return c;
	}
	function opRender(v, r) {
		var str = "<a href='javascript:;' onclick='del()'>删除</a>";
		return str;
	}
	function del() {

	}
	$('#adddetail').click(function(){
		//$('#detail').table('addRow', 0, {});
		add();
	});
	function add() {
		$.dialog({
			title : '新增明细',
			url : 'view/income/adddetail.html',
			drag : true,
			buttons : [ {
				text : '确定',
				cls : 'btn-primary',
				action : function(d) {
					var goods = $('#goods').selectbox('getValue');
					var spec = $('#spec').val();
					var unit = $('#unit').selectbox('getValue');
					var purchase_price = $('#purchase_price').val();
					var purchase_num = $('#purchase_num').val();
					var purchase_money = $('#purchase_money').val();
					var data = {goods : goods, spec : spec, unit : unit, purchase_price : purchase_price, purchase_num : purchase_num, purchase_money : purchase_money};
					$('#detail').table('appendData', data);
				}
			}, {
				text : '关闭',
				cls : 'btn-default',
				action : function(d) {
					d.close();
				}

			} ]
		});
		//$('#kkk').Grid('addRow', {username:'asd'});
	}
	$('#savedetail').click(function(){
		
	});
</script>