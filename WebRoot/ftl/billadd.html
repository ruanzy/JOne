<form class="form-horizontal" role="form">
	<div class="form-group">
		<label class="col-sm-1 control-label" for="no">编号</label>
		<div class="col-sm-3">
			<input class="form-control" id="no" type="text" disabled="disabled"/>
		</div>
		<label class="col-sm-2 control-label" for="createtime">拟定时间</label>
		<div class="col-sm-2">
			<input class="form-control" id="createtime" type="text" disabled="disabled"/>
		</div>
		<label class="col-sm-2 control-label" for="createtor">拟定人</label>
		<div class="col-sm-2">
			<input class="form-control" id="createtor" type="text" />
		</div>
	</div>
	<div class="form-group">
		<label class="col-sm-1 control-label" for="supplier">供应商</label>
		<div class="col-sm-3">
			<input class="form-control" id="supplier" type="text" style='width:100%' />
		</div>
		<label class="col-sm-2 control-label" for="warehouse">入库仓库</label>
		<div class="col-sm-2">
			<input class="form-control" id="warehouse" type="text" style='width:100%' />
		</div>
		<label class="col-sm-2 control-label" for="memo">备注</label>
		<div class="col-sm-2">
			<input class="form-control" id="memo" type="text" />
		</div>
	</div>
</form>
<p>
	<a id='adddetail' class='btn btn-primary'><i class="icon-plus"></i>
		新建明细</a>
</p>
<div id='detail'></div>
<script type="text/javascript">
	/**$('#supplier').selectbox({
		url : 'supplier/list',
		textField : 'name',
		valueField : 'id'
	});**/
	$.ajax({
		url : 'supplier/list',
		type : 'get',
		async : false,
		dataType : 'json',
		success : function(result) {
			var data = [];
			$(result).each(function() {
				data.push({
					id : this['id'],
					text : this['name']
				});
			});
			$('#supplier').select2({
				data : data
			});
		}
	});
	/**$('#warehouse').selectbox({
		url : 'warehouse/list',
		textField : 'name',
		valueField : 'id'
	});**/
	$.ajax({
		url : 'warehouse/list',
		type : 'get',
		async : false,
		dataType : 'json',
		success : function(result) {
			var data = [];
			$(result).each(function() {
				data.push({
					id : this['id'],
					text : this['name']
				});
			});
			$('#warehouse').select2({
				data : data
			});
		}
	});
	var date = new Date();
	var yyyy = date.getFullYear();
	var MM = date.getMonth() + 1;
	var dd = date.getDate();
	$('#no').val('P_' + date.format("yyyyMMddhhmmss"));
	$('#createtime').val(yyyy + '-' + MM + '-' + dd);
	var unit;
	$.ajax({
		url : "goods/unitlist",
		async : false,
		type : 'post',
		dataType : 'json',
		success : function(data) {
			if (data) {
				unit = data;
			}
		}
	});
	var goods;
	$.ajax({
		url : "goods/list",
		async : false,
		type : 'post',
		dataType : 'json',
		success : function(data) {
			if (data) {
				goods = data;
			}
		}
	});
	$('#detail').table({
		columns : [
		//{header:"ID",field:"id",width:50,align:'center'},
		{
			header : "商品名",
			field : "goods",
			align : 'left',
			tip : true,
			render : goodsRender
		}, {
			header : "规格",
			field : "spec",
			align : 'left',
			width : 180
		}, {
			header : "计量单位",
			field : "unit",
			align : 'left',
			width : 100,
			render : unitRender
		}, {
			header : "采购价格",
			field : "purchase_price",
			align : 'left',
			width : 100
		}, {
			header : "采购数量",
			field : "purchase_num",
			align : 'center',
			width : 100
		}, {
			header : "采购金额",
			field : "purchase_money",
			align : 'center',
			width : 100
		}, {
			header : "操作",
			field : "",
			align : 'center',
			width : 80,
			render : opRender
		} ],
		pager: false,
		data : []
	});
	function unitRender(v, r) {
		var c;
		$.each(unit, function() {
			if (this['id'] == v) {
				c = this['name'];
				return false;
			}
		});
		return c;
	}
	function goodsRender(v, r) {
		var c;
		$.each(goods, function() {
			if (this['id'] == v) {
				c = this['name'];
				return false;
			}
		});
		return c;
	}
	function opRender(v, r) {
		var str = "<a href='javascript:;' onclick='del(this)'>删除</a>";
		return str;
	}
	function del(obj) {
		var idx = $(obj).parents('tr').get(0).rowIndex;
		$('#detail').table('deleteRow', idx);
	}
	$('#adddetail').click(function() {
		$.dialog({
			title : '新增明细',
			url : 'view/income/adddetail.html',
			drag : true,
			buttons : [ {
				text : '确定',
				cls : 'btn-primary',
				action : function(d) {
					var goods = $('#goods').selectbox('getValue');
					var spec = $('#spec').val();
					var unit = $('#unit').selectbox('getValue');
					var purchase_price = $('#purchase_price').val();
					var purchase_num = $('#purchase_num').val();
					var purchase_money = $('#purchase_money').val();
					var data = {
						goods : goods,
						spec : spec,
						unit : unit,
						purchase_price : purchase_price,
						purchase_num : purchase_num,
						purchase_money : purchase_money
					};
					$('#detail').table('appendRow', data);
				}
			}, {
				text : '关闭',
				cls : 'btn-default',
				action : function(d) {
					d.close();
				}

			} ]
		});
	});
</script>