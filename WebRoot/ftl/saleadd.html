<from>
<table style='width:100%'>
	<tr>
		<td>销售单编号</td>
		<td><input type="text" id='no' name="no" class='txt'
			autocomplete="off" disabled="disabled"/></td>
		<td>拟定时间</td>
		<td><input type="text" id='createtime' name='createtime' class='txt' disabled="disabled"/></td>
		<td>拟定人</td>
		<td><input type="text" id='creator' name="creator" value=${user} class='txt' disabled="disabled"/></td>
	</tr>
	<tr>
		<td>客户名称</td>
		<td><input type="text" id='customer' name='customer' class='txt' /></td>
		<td>出库仓库</td>
		<td><input type="text" id='warehouse' name="warehouse" class='txt' /></td>
		<td>备注</td>
		<td><input type="text" id='memo' name="memo" class='txt' /></td>
	</tr>
</table>
</from>
<p>
<a id='adddetail' class='btn btn-primary'><i class="icon-plus"></i> 新建明细</a>
</p>
<div id='detail'></div>
<script type="text/javascript">
	$('#customer').selectbox({
		url : 'customer/list',
		textField : 'name',
		valueField : 'id'
	});
	$('#warehouse').selectbox({
		url : 'warehouse/list',
		textField : 'name',
		valueField : 'id'
	});
	var date = new Date();
	var yyyy = date.getFullYear();
	var MM = date.getMonth() + 1;
	var dd = date.getDate();
	$('#no').val('S' + date.format("yyyyMMddhhmmss"));
	$('#createtime').val(yyyy + '-' + MM + '-' + dd);
	var unit;
	$.ajax({
		url : "goods/unitlist",
		async : false,
		type : 'post',
		dataType : 'json',
		success : function(data) {
			if (data) {
				unit = data;
			}
		}
	});
	var goods;
	$.ajax({
		url : "goods/list",
		async : false,
		type : 'post',
		dataType : 'json',
		success : function(data) {
			if (data) {
				goods = data;
			}
		}
	});
	$('#detail').table({
		columns : [
		//{header:"ID",field:"id",width:50,align:'center'},
		{
			header : "商品名",
			field : "goods",
			align : 'left',
			tip : true,
			render : goodsRender
		}, {
			header : "规格",
			field : "spec",
			align : 'left',
			width : 180
		}, {
			header : "计量单位",
			field : "unit",
			align : 'left',
			width : 100,
			render : unitRender
		}, {
			header : "销售价格",
			field : "sale_price",
			align : 'left',
			width : 100
		}, {
			header : "销售数量",
			field : "sale_num",
			align : 'center',
			width : 100
		}, {
			header : "销售金额",
			field : "sale_money",
			align : 'center',
			width : 100
		}, {
			header : "操作",
			field : "",
			align : 'center',
			width : 80,
			render : opRender
		} ],
		data : []
	});
	function unitRender(v, r) {
		var c;
		$.each(unit, function(){
			if(this['id'] == v){
				c = this['name'];
				return false;
			}
		});
		return c;
	}
	function goodsRender(v, r) {
		var c;
		$.each(goods, function(){
			if(this['id'] == v){
				c = this['name'];
				return false;
			}
		});
		return c;
	}
	function opRender(v, r) {
		var str = "<a href='javascript:;' onclick='del(this)'>删除</a>";
		return str;
	}
	function del(obj) {
		var idx = $(obj).parents('tr').get(0).rowIndex;
		$('#detail').table('deleteRow', idx);
	}
	$('#adddetail').click(function(){
		$.dialog({
			title : '新增明细',
			url : 'view/sale/adddetail.html',
			drag : true,
			buttons : [ {
				text : '确定',
				cls : 'btn-primary',
				action : function(d) {
					var goods = $('#goods').selectbox('getValue');
					var spec = $('#spec').val();
					var unit = $('#unit').selectbox('getValue');
					var sale_price = $('#sale_price').val();
					var sale_num = $('#sale_num').val();
					var sale_money = $('#sale_money').val();
					var data = {goods : goods, spec : spec, unit : unit, sale_price : sale_price, sale_num : sale_num, sale_money : sale_money};
					$('#detail').table('appendRow', data);
				}
			}, {
				text : '关闭',
				cls : 'btn-default',
				action : function(d) {
					d.close();
				}

			} ]
		});
	});
</script>